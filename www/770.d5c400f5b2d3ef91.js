"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[770],{770:(tt,y,a)=>{a.r(y),a.d(y,{TreksMapPageModule:()=>X});var h=a(9808),T=a(2029),b=a(4272),r=a(786),k=a(7232),u=a(655),S=a(9841),_=a(7489),m=a(5722),I=a(1158),Z=a(24),x=a(5857),t=a(7587),M=a(5407),v=a(8317),C=a(8413),z=a(4898),L=a(8306),A=a(9300),N=a(1884);function O(o,l){if(1&o){const e=t.EpF();t.TgZ(0,"ion-img",9),t.NdJ("ionError",function(){t.CHM(e);const s=t.oxw().index;return t.oxw(2).onImgPracticeSrcError(s)}),t.qZA()}if(2&o){const e=t.oxw(),i=e.$implicit,s=e.index,n=t.oxw(2);t.Udp("background-color",i.imgPractice.color?i.imgPractice.color:"transparent"),t.Q6J("src",n.imgPractices[s].src)}}function F(o,l){if(1&o&&(t.TgZ(0,"ion-item"),t._UZ(1,"ion-radio",6),t.YNc(2,O,1,3,"ion-img",7),t.TgZ(3,"ion-label",8),t._uU(4),t.qZA()()),2&o){const e=l.$implicit,i=l.index,s=t.oxw(2);t.xp6(1),t.Q6J("value",e.id),t.xp6(1),t.Q6J("ngIf",e.imgPractice.src&&!s.imgPractices[i].hideImgPracticeSrc),t.xp6(2),t.Oqu(e.name)}}function U(o,l){if(1&o){const e=t.EpF();t.TgZ(0,"ion-list")(1,"ion-radio-group",4),t.NdJ("ionChange",function(s){return t.CHM(e),t.oxw().selectedTrekChange(s)}),t.TgZ(2,"ion-list-header"),t._uU(3),t.ALo(4,"translate"),t.qZA(),t.YNc(5,F,5,3,"ion-item",5),t.qZA()()}if(2&o){const e=t.oxw();t.xp6(1),t.Q6J("value",e.selectedTrekId),t.xp6(2),t.hij(" ",t.lcZ(4,3,"mapTreks.treksAlert.informUser")," "),t.xp6(2),t.Q6J("ngForOf",e.radioTreks)}}let E=(()=>{class o{constructor(e,i){this.modalController=e,this.offlineTreks=i,this.baseUrl=m.N.onlineBaseUrl,this.imgPractices=[]}ngOnInit(){return(0,u.mG)(this,void 0,void 0,function*(){this.selectedTrekId=this.radioTreks[0].id;for(const e of this.radioTreks)this.imgPractices.push(Object.assign(Object.assign({},e.imgPractice),{src:yield this.offlineTreks.getTrekImageSrc({},{url:e.imgPractice.src}),firstTryToLoadFromOnline:!0,hideImgPracticeSrc:!1}))})}cancel(){this.modalController.dismiss()}select(){this.modalController.dismiss({selectedTrekId:this.selectedTrekId})}selectedTrekChange(e){this.selectedTrekId=e.detail.value}onImgPracticeSrcError(e){this.imgPractices[e].src&&this.imgPractices[e].firstTryToLoadFromOnline?(this.imgPractices[e].firstTryToLoadFromOnline=!1,this.imgPractices[e].src=`${this.baseUrl}${this.imgPractices[e].src}`):this.imgPractices[e].hideImgPracticeSrc=!0}}return o.\u0275fac=function(e){return new(e||o)(t.Y36(r.IN),t.Y36(v.U))},o.\u0275cmp=t.Xpm({type:o,selectors:[["app-select-trek"]],inputs:{radioTreks:"radioTreks"},decls:16,vars:10,consts:[["color","primary"],[4,"ngIf"],["slot","end"],["color","primary","fill","clear",3,"click"],[3,"value","ionChange"],[4,"ngFor","ngForOf"],["slot","start",3,"value"],["style","width: 24px; height: 24px; margin-right: 12px",3,"background-color","src","ionError",4,"ngIf"],[1,"ion-text-wrap"],[2,"width","24px","height","24px","margin-right","12px",3,"src","ionError"]],template:function(e,i){1&e&&(t.TgZ(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),t._uU(3),t.ALo(4,"translate"),t.qZA()()(),t.TgZ(5,"ion-content"),t.YNc(6,U,6,5,"ion-list",1),t.qZA(),t.TgZ(7,"ion-footer")(8,"ion-toolbar")(9,"ion-buttons",2)(10,"ion-button",3),t.NdJ("click",function(){return i.cancel()}),t._uU(11),t.ALo(12,"translate"),t.qZA(),t.TgZ(13,"ion-button",3),t.NdJ("click",function(){return i.select()}),t._uU(14),t.ALo(15,"translate"),t.qZA()()()()),2&e&&(t.xp6(3),t.hij(" ",t.lcZ(4,4,"mapTreks.treksAlert.title")," "),t.xp6(3),t.Q6J("ngIf",i.imgPractices.length===i.radioTreks.length),t.xp6(5),t.hij(" ",t.lcZ(12,6,"mapTreks.treksAlert.cancelButton")," "),t.xp6(3),t.hij(" ",t.lcZ(15,8,"mapTreks.treksAlert.confirmButton")," "))},directives:[r.Gu,r.sr,r.wd,r.W2,h.O5,r.q_,r.se,r.QI,r.yh,h.sg,r.Ie,r.B7,r.U5,r.Xz,r.Q$,r.fr,r.Sm,r.YG],pipes:[k.X$],styles:[""]}),o})();var Y=a(3036),J=a(9898),f=a.n(J),w=a(7423),P=a(6953),$=a(1345);const D=["mapViz"];let G=(()=>{class o{constructor(e,i,s,n,p,c,d){this.settings=e,this.platform=i,this.geolocate=s,this.modalController=n,this.alertController=p,this.translate=c,this.offlineTreks=d,this.filteredTreks=null,this.navigateToTrek=new t.vpe,this.flyToUserLocation=(0,_.throttle)(this.flyToUserLocation,3e3)}ngOnChanges(e){const i=e.filteredTreks;if(i)if(i.currentValue&&!i.previousValue)this.createMap();else if(this.map){const s=this.map.getSource("treks-points");s&&this.filteredTreks&&s.setData({type:"FeatureCollection",features:this.filteredTreks})}}ngOnDestroy(){this.geolocate.stopOnMapTracking(),this.currentPositionSubscription&&this.currentPositionSubscription.unsubscribe(),this.currentHeadingSubscription&&this.currentHeadingSubscription.unsubscribe(),this.loadImagesSubscription&&this.loadImagesSubscription.unsubscribe()}createMap(){return(0,u.mG)(this,void 0,void 0,function*(){if(this.mapConfig&&this.mapConfig.style&&this.filteredTreks){this.offline&&(this.platform.is("ios")||this.platform.is("android"))&&(this.mapConfig.style.sources["tiles-background"].tiles[0]=`${w.dV.convertFileSrc((yield P.fy.getUri({path:"offline",directory:P.tP.Data})).uri)}/tiles/{z}/{x}/{y}.png`);const e=[];this.filteredTreks.forEach(n=>{n&&n.geometry&&n.geometry.coordinates&&n.geometry.coordinates[0]&&n.geometry.coordinates[1]&&e.push(n.geometry.coordinates)});const i=e.reduce((n,p)=>n.extend(p),new(f().LngLatBounds)(e[0],e[0]));this.map=new(f().Map)(Object.assign(Object.assign({},this.mapConfig),{container:"map-treks"})),i&&i._ne&&i._sw&&this.map.fitBounds(i,m.N.map.TreksfitBoundsOptions),this.map.addControl(new(f().NavigationControl)({showCompass:!1}),"top-left"),this.map.addControl(new(f().ScaleControl)({unit:"metric"})),this.map.addControl(new(f().AttributionControl)({compact:!1,customAttribution:m.N.map.attributionText})),m.N.map.enableRotation||(this.map.dragRotate.disable(),this.map.touchZoomRotate.disableRotation());const s=L.y.create(n=>{const p=this.dataSettings.find(c=>"practice"===c.id);p&&(this.practices=p,p.values.forEach((c,d)=>(0,u.mG)(this,void 0,void 0,function*(){this.map.loadImage(yield this.offlineTreks.getTrekImageSrc({},{url:c.pictogram}),(g,W)=>{g?this.map.loadImage(`${this.commonSrc}${c.pictogram}`,(K,q)=>{K||this.map.addImage(c.id.toString(),q),d+1===p.values.length&&n.complete()}):(this.map.addImage(c.id.toString(),W),d+1===p.values.length&&n.complete())})})))});this.currentPositionSubscription=this.geolocate.currentPosition$.pipe((0,A.h)(n=>null!==n),(0,N.x)()).subscribe(n=>(0,u.mG)(this,void 0,void 0,function*(){const p=[n.longitude,n.latitude];if(this.markerPosition)this.markerPosition.setLngLat(p);else{const c=document.createElement("div"),d=yield this.geolocate.checkIfCanGetCurrentHeading();c.className=d?"pulse-and-view":"pulse",this.markerPosition=new(f().Marker)({element:c}).setLngLat(p),this.markerPosition&&this.markerPosition.addTo(this.map)}})),this.currentHeadingSubscription=this.geolocate.currentHeading$.subscribe(n=>{this.markerPosition&&n&&this.markerPosition.setRotation(n)}),this.loadImagesSubscription=s.subscribe({complete:()=>(0,u.mG)(this,void 0,void 0,function*(){this.addSourcesLayersEvents(),(yield this.geolocate.shouldShowInAppDisclosure())&&(yield this.presentInAppDisclosure()),this.geolocate.startOnMapTracking()})})}})}addSourcesLayersEvents(){return(0,u.mG)(this,void 0,void 0,function*(){this.map.addSource("treks-points",{type:"geojson",data:{type:"FeatureCollection",features:this.filteredTreks},maxzoom:this.mapConfig.maxZoom?this.mapConfig.maxZoom+1:18,cluster:!0,clusterRadius:50}),this.map.addSource("zone",{type:"geojson",data:yield this.settings.getZoneFromStorage()}),this.map.addLayer(Object.assign({id:"zone",source:"zone"},m.N.map.zoneLayerProperties)),this.map.addLayer(Object.assign({id:"zone-outline",source:"zone"},m.N.map.zoneOutlineLayerProperties)),this.map.addLayer({id:"clusters-circle",type:"circle",source:"treks-points",filter:["has","point_count"],paint:m.N.map.clusterPaint}),this.map.addLayer({id:"cluster-text-count",type:"symbol",source:"treks-points",filter:["has","point_count"],paint:m.N.map.clusterTextPaint,layout:{"text-field":"{point_count_abbreviated}","text-font":["Roboto Regular"],"text-size":16,"text-offset":[0,.1]}});const e=[];e.push("match"),e.push(["get","practice"]),this.practices.values.forEach(i=>{e.push(i.id),e.push(i.color)}),e.push(m.N.map.clusterPaint["circle-color"]),this.map.addLayer({id:"trek-point",type:"circle",source:"treks-points",filter:["!",["has","point_count"]],paint:Object.assign(Object.assign({},m.N.map.clusterPaint),{"circle-color":e,"circle-radius":16})}),this.map.addLayer({id:"trek-point-icon",type:"symbol",source:"treks-points",filter:["!",["has","point_count"]],layout:{"icon-image":["get","practice"],"icon-size":m.N.map.globalMapIconSize}}),this.map.on("click","clusters-circle",i=>{const s=this.map.queryRenderedFeatures(i.point,{layers:["clusters-circle"]}),n=s[0].properties;if(n){const p=n.cluster_id;this.map.getZoom()===this.mapConfig.maxZoom?this.map.getSource("treks-points").getClusterLeaves(n.cluster_id,1/0,0,(c,d)=>{if(c)throw c;this.presentConfirmFeatures(d)}):this.map.getSource("treks-points").getClusterExpansionZoom(p,(c,d)=>{if(c)return;const g=s[0].geometry.coordinates;this.map.easeTo({center:[g[0],g[1]],zoom:d})})}}),this.map.on("click","trek-point",i=>{const s=this.map.queryRenderedFeatures(i.point,{layers:["trek-point"]})[0];s.properties&&this.navigateToTrek.emit(s.properties.id)}),this.mapViz.nativeElement.mapInstance=this.map})}presentConfirmFeatures(e){return(0,u.mG)(this,void 0,void 0,function*(){const i=[];e.forEach(p=>{const c=this.settings.getHydratedTrek(p,this.commonSrc);i.push({id:c.properties.id,name:c.properties.name,imgPractice:{src:c.properties.practice.pictogram,color:c.properties.practice.color}})});const s=yield this.modalController.create({component:E,componentProps:{radioTreks:i},cssClass:"full-size"});yield s.present();const{data:n}=yield s.onDidDismiss();n&&n.selectedTrekId&&this.navigateToTrek.emit(n.selectedTrekId)})}flyToUserLocation(){return(0,u.mG)(this,void 0,void 0,function*(){const e=yield this.geolocate.getCurrentPosition();if(e){const i=[e.longitude,e.latitude];if(this.markerPosition)this.markerPosition.setLngLat(i);else{const s=document.createElement("div"),n=yield this.geolocate.checkIfCanGetCurrentHeading();s.className=n?"pulse-and-view":"pulse",this.markerPosition=new(f().Marker)({element:s}).setLngLat(i),this.markerPosition&&this.markerPosition.addTo(this.map)}this.map.flyTo({center:i,animate:!1,zoom:m.N.trekZoom.zoom})}else{const i=yield this.translate.get("geolocate.error").toPromise();yield(yield this.alertController.create({header:i.header,subHeader:i.subHeader,message:i.message,buttons:[i.confirmButton]})).present()}})}presentInAppDisclosure(){return(0,u.mG)(this,void 0,void 0,function*(){const e=yield this.modalController.create({component:Y.e,componentProps:{},cssClass:"full-size"});yield e.present(),yield e.onDidDismiss()})}}return o.\u0275fac=function(e){return new(e||o)(t.Y36(C.g),t.Y36(r.t4),t.Y36($.x),t.Y36(r.IN),t.Y36(r.Br),t.Y36(k.sK),t.Y36(v.U))},o.\u0275cmp=t.Xpm({type:o,selectors:[["app-map-treks-viz"]],viewQuery:function(e,i){if(1&e&&t.Gf(D,5),2&e){let s;t.iGM(s=t.CRH())&&(i.mapViz=s.first)}},inputs:{filteredTreks:"filteredTreks",mapConfig:"mapConfig",dataSettings:"dataSettings",commonSrc:"commonSrc",offline:"offline"},outputs:{navigateToTrek:"navigateToTrek"},features:[t.TTD],decls:5,vars:0,consts:[["id","map-treks",1,"map-viz"],["mapViz",""],[1,"options-button-container"],["shape","round","size","small","color","light",3,"click"],["color","dark","name","locate"]],template:function(e,i){1&e&&(t._UZ(0,"div",0,1),t.TgZ(2,"div",2)(3,"ion-button",3),t.NdJ("click",function(){return i.flyToUserLocation()}),t._UZ(4,"ion-icon",4),t.qZA()())},directives:[r.YG,r.gu],styles:[".options-button-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;position:absolute;right:24px;top:24px;z-index:5}"]}),o})();function H(o,l){if(1&o){const e=t.EpF();t.TgZ(0,"ion-toolbar")(1,"ion-grid",4)(2,"ion-row")(3,"ion-col",5)(4,"ion-button",6),t.NdJ("click",function(){return t.CHM(e),t.oxw().presentFilters()}),t._uU(5),t.ALo(6,"translate"),t.qZA(),t.TgZ(7,"ion-button",7),t.NdJ("click",function(){return t.CHM(e),t.oxw().presentSearch()}),t._uU(8),t.ALo(9,"translate"),t.qZA()()()()()}if(2&o){const e=t.oxw();t.xp6(5),t.AsE(" ",t.lcZ(6,3,"toolbar.filters")," ",e.numberOfActiveFilters,""),t.xp6(3),t.hij(" ",t.lcZ(9,5,"toolbar.search"),"")}}function j(o,l){if(1&o){const e=t.EpF();t.TgZ(0,"app-connect-error",9),t.NdJ("retry",function(){return t.CHM(e),t.oxw(2).loadTreks()}),t.ALo(1,"translate"),t.ALo(2,"translate"),t.ALo(3,"translate"),t.qZA()}2&o&&t.Q6J("title",t.lcZ(1,3,"error.title"))("content",t.lcZ(2,5,"error.TreksMap"))("buttonText",t.lcZ(3,7,"error.buttonText"))}function Q(o,l){if(1&o&&(t.ynx(0),t.YNc(1,j,4,9,"app-connect-error",8),t.ALo(2,"async"),t.BQk()),2&o){const e=t.oxw(),i=t.MAs(9);t.xp6(1),t.Q6J("ngIf",t.lcZ(2,2,e.onlineTreks.onlineTreksError$))("ngIfElse",i)}}function V(o,l){if(1&o){const e=t.EpF();t.TgZ(0,"app-map-treks-viz",14),t.NdJ("navigateToTrek",function(s){return t.CHM(e),t.oxw(2).navigateToTrek(s)}),t.qZA()}if(2&o){const e=t.oxw(2);t.Q6J("offline",e.offline)("filteredTreks",e.filteredTreks)("mapConfig",e.mapConfig)("dataSettings",e.settings.data$.value)("commonSrc",e.commonSrc)}}function B(o,l){if(1&o&&(t.YNc(0,V,1,5,"app-map-treks-viz",10),t.TgZ(1,"ion-fab",11)(2,"ion-fab-button",12),t._UZ(3,"ion-icon",13),t.qZA()()),2&o){const e=t.oxw();t.Q6J("ngIf",e.canDisplayMap),t.xp6(2),t.Q6J("routerLink",e.treksUrl)}}const R=[{path:"",component:(()=>{class o{constructor(e,i,s,n,p,c,d,g){this.filterTreks=e,this.modalController=i,this.onlineTreks=s,this.offlineTreks=n,this.router=p,this.route=c,this.settings=d,this.platform=g,this.appName=m.N.appName,this.canDisplayMap=!1}ngOnInit(){return(0,u.mG)(this,void 0,void 0,function*(){this.treksTool||(this.offline=!!this.route.snapshot.data.offline,this.treksTool=this.offline?this.offlineTreks:this.onlineTreks,this.treksUrl=this.treksTool.getTreksUrl(),this.mapConfig=(0,_.cloneDeep)(this.offline&&(this.platform.is("ios")||this.platform.is("android"))?m.N.offlineMapConfig:m.N.onlineMapConfig),this.commonSrc=yield this.treksTool.getCommonImgSrc()),this.mergeFiltersTreks$=(0,S.a)([this.offline?this.offlineTreks.filteredTreks$:this.onlineTreks.filteredTreks$,this.filterTreks.activeFiltersNumber$]).subscribe(([i,s])=>{this.numberOfActiveFilters=0===s?"":`(${s})`,this.filteredTreks=i})})}ngOnDestroy(){this.mergeFiltersTreks$&&this.mergeFiltersTreks$.unsubscribe()}ionViewWillEnter(){this.canDisplayMap=!0}presentFilters(){return(0,u.mG)(this,void 0,void 0,function*(){yield(yield this.modalController.create({component:I.b,componentProps:{isOnline:!this.offline},cssClass:"full-size"})).present()})}presentSearch(){return(0,u.mG)(this,void 0,void 0,function*(){const e=yield this.modalController.create({component:Z.g,componentProps:{isOnline:!this.offline},cssClass:"full-size"});yield e.present();const{data:i}=yield e.onDidDismiss();i&&this.navigateToTrek(i)})}navigateToTrek(e){this.router.navigate([this.treksTool.getTrekDetailsUrl(e)])}loadTreks(){this.settings.loadSettings(),this.onlineTreks.loadTreks()}}return o.\u0275fac=function(e){return new(e||o)(t.Y36(x.Z),t.Y36(r.IN),t.Y36(M.a),t.Y36(v.U),t.Y36(T.F0),t.Y36(T.gz),t.Y36(C.g),t.Y36(r.t4))},o.\u0275cmp=t.Xpm({type:o,selectors:[["app-treks-map"]],features:[t._Bn([x.Z])],decls:10,vars:6,consts:[["color","primary"],[4,"ngIf"],[4,"ngIf","ngIfElse"],["treksMap",""],[1,"ion-no-padding"],[1,"vertical-center","ion-margin-start"],["color","light","size","small",1,"custom-button",3,"click"],["color","light","size","small",1,"custom-button","ion-margin-start",3,"click"],["icon","wifi",3,"title","content","buttonText","retry",4,"ngIf","ngIfElse"],["icon","wifi",3,"title","content","buttonText","retry"],[3,"offline","filteredTreks","mapConfig","dataSettings","commonSrc","navigateToTrek",4,"ngIf"],["vertical","bottom","horizontal","end","slot","fixed"],[1,"no-outline",3,"routerLink"],["name","reorder-four-outline"],[3,"offline","filteredTreks","mapConfig","dataSettings","commonSrc","navigateToTrek"]],template:function(e,i){if(1&e&&(t.TgZ(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),t._uU(3),t.qZA()(),t.YNc(4,H,10,7,"ion-toolbar",1),t.ALo(5,"async"),t.qZA(),t.TgZ(6,"ion-content"),t.YNc(7,Q,3,4,"ng-container",2),t.YNc(8,B,4,2,"ng-template",null,3,t.W1O),t.qZA()),2&e){const s=t.MAs(9);t.xp6(3),t.hij(" ",i.appName," "),t.xp6(1),t.Q6J("ngIf",!t.lcZ(5,4,i.onlineTreks.onlineTreksError$)&&!i.offline||i.offline&&i.filteredTreks&&i.filteredTreks.length>0),t.xp6(3),t.Q6J("ngIf",!i.offline)("ngIfElse",s)}},directives:[r.Gu,r.sr,r.wd,h.O5,r.jY,r.Nd,r.wI,r.YG,r.W2,z.t,G,r.IJ,r.W4,r.YI,T.rH,r.gu],pipes:[h.Ov,k.X$],styles:[".custom-button[_ngcontent-%COMP%]{width:100px;text-transform:capitalize}.vertical-center[_ngcontent-%COMP%]{display:flex;align-items:center}"]}),o})()}];let X=(()=>{class o{}return o.\u0275fac=function(e){return new(e||o)},o.\u0275mod=t.oAB({type:o}),o.\u0275inj=t.cJS({imports:[[h.ez,r.Pc,T.Bz.forChild(R),b.e,k.aw.forChild()]]}),o})()}}]);